angular.module("jnGrid",[]).factory("syncService",[function(){function e(e){var o=new XMLHttpRequest;return o.open("GET",e,!1),o.send(null),o.responseText}return{get:e}}]).filter("jnfilter",["$filter",function(e){return function(o,t){if(t){var n=[],t=t.split(":"),r=e(t.shift());return t.length>1&&(n[0]=t.join(":")),n.unshift(o),r.apply(null,n)}return o}}]).directive("jnGridCell",[function(){return{restrict:"EA",requires:"jnGrid",replace:!0,scope:{value:"=",filter:"@?"},template:"<td>{{ value | jnfilter: filter }}</td>"}}]).directive("jnGridHeader",[function(){return{restrict:"EA",requires:"jnGrid",replace:!0,template:"<th class=\"jnHeader th-{{ $parent.$id }} {{ column.sortable ? 'clickable' : '' }}\" ng-click=\"clickFn()\">{{ column.displayName || column.field }}</th>",link:function(e,o){e.clickFn=function(){if(e.column.sortable){if(e.$parent.sortCol===e.column.field)e.$parent.sortDir=!e.$parent.sortDir;else{var t=".th-"+e.$parent.$id+".sorted";angular.element(document.querySelector(t)).removeClass("sorted"),o.addClass("sorted"),e.$parent.sortCol=e.column.field,e.$parent.sortDir=!1}o.removeClass("sort-"+!e.$parent.sortDir),o.addClass("sort-"+e.$parent.sortDir)}}}}}]).directive("jnGridRow",["$compile","$rootScope",function(e){function o(e,o,n){var r;n&&n(e,function(e){r=e,o.after(e),o.addClass("clickable")}),o.bind("click",function(){t(e,o,r)})}function t(e,o,t){function n(){e.options.multiSelect?e.options.selected.rows.push(e.row):(e.options.selected.rows[0]=e.row,angular.element(document.querySelector("jn-grid-row.selected")).removeClass("selected"),angular.element(document.querySelector(".jnAccordion.selected")).removeClass("selected")),o.addClass("selected"),t&&t.addClass("selected"),e.options.selected.item=e.row,e.$emit("jnRowSelect",e.options.id,e.row)}function r(){if(e.options.multiSelect){var n=e.options.selected.rows.indexOf(e.row);n>-1&&e.options.selected.rows.splice(n,1)}else e.options.selected.rows[0]=void 0;o.removeClass("selected"),t&&t.removeClass("selected"),e.options.selected.item=void 0,e.$emit("jnRowDeselect",e.options.id,e.row)}e.options.enableRowSelection&&(e.options.selected.rows.indexOf(e.row)>-1?r():n()),t&&(e.options.showAccordionFn?e.options.showAccordionFn(e.row):e.row.show=!e.row.show,e.$apply())}function n(o,t){var n=o.options.columns;for(var r in n)t.append(e('<div jn-grid-cell value="row.'+n[r].field+'" filter="'+(n[r].filter?n[r].filter:"")+'"></div>')(o))}return{restrict:"EA",requires:"jnGrid",link:function(e,t){var r=e.row;r.show=!1,e.$watch("dataset",function(){n(e,t)}),o(e,t,e.options.accordion)}}}]).directive("jnGrid",["$compile","$templateCache","syncService",function(e,o,t){function n(e){var n=t.get(e);return o.put(e,n),n}function r(t){if(t.options.accordionUrl&&(t.options.accordion=o.get(t.options.accordionUrl)||n(t.options.accordionUrl)),t.options.accordion){var r=angular.element("<td>"+t.options.accordion+"</td>");r.addClass("jnAccordion"),r.attr("colspan",t.options.columns.length),r.attr("ng-class","{ jnRowEven: $even, jnRowOdd: $odd }"),r.attr("ng-show","row.show"),t.options.accordion=e(r)}}function i(e){var o=["$$hashKey","clicked","show"];if(e.dataset&&e.dataset.length>0&&!e.options.columns){e.options.columns=[];var t=Object.keys(e.dataset[0]);for(var n in t){var r=t[n];-1===o.indexOf(r)&&e.options.columns.push({field:r})}}}return{restrict:"EA",scope:{dataset:"=",options:"=?"},template:'<table><tr><jn-grid-header ng-repeat="column in options.columns"></jn-grid-header></tr><jn-grid-row ng-class="{ jnRowEven: $even, jnRowOdd: $odd }"ng-repeat="row in dataset | orderBy:sortCol:sortDir"></jn-grid-row></table>',link:function(e){e.options=e.options||{},void 0===e.options.enableRowSelection&&(e.options.enableRowSelection=!0),e.options.selected={},e.options.selected.rows=[],e.options.columns||e.$watch("dataset",function(){i(e)}),i(e),r(e)}}}]);